# Current Mission: B7.1.1 - OpenAPI Parser Extensions & Error Model
*Week 7, Days 3-4 - Advanced Features & Resilience*

## Mission Status
- **Phase**: Week 7 - Protocol Suite Enhancement
- **Mission ID**: B7.1.1
- **Status**: ACTIVE ðŸš€
- **Started**: 2025-10-06
- **Completed**: [TBD]
- **Target Completion**: 2 days
- **Dependencies**: B7.1.0 Complete âœ…

---

## Mission Overview

Extend the core OpenAPI parser with advanced capabilities including external $ref resolution, circular reference detection, comprehensive error handling, and progress tracking. This mission transforms the parser from a basic tool into a production-ready, resilient component suitable for enterprise workflows.

### Why This Matters
- **B7.2.0** (Agent Registration): Needs robust error handling for registration failures
- **B7.2.1** (Registry Integration): Requires external $ref resolution for distributed specs
- **Future**: Foundation for protocol validation pipelines and automated compliance checking

---

## Research Foundation

**Primary Research**:
- `missions/research/SPRINT_07_RESEARCH_R7.1.md` - Parser architecture & performance
- `missions/research/SPRINT_07_RESEARCH_R7.2.md` - Error models & observability patterns

### Key Findings Applied
1. **External $ref resolution**: Use indexed resolution with caching to prevent N+1 fetching
2. **Circular detection**: Tarjan's algorithm for strongly connected components (already in codebase)
3. **Error taxonomy**: Structured error codes with severity levels (ERROR, WARN, INFO)
4. **Progress events**: EventEmitter pattern for streaming progress updates
5. **Retry logic**: Exponential backoff for network failures during ref resolution

### Performance Targets
```yaml
external_ref_resolution: <500ms per ref (with caching)
circular_detection: <50ms for typical specs
error_model_overhead: <10ms additional processing
progress_events: <1ms per event emission
memory_efficiency: <100MB for 50k line spec with external refs
```

---

## Technical Scope

### Core Deliverables

#### 1. External $ref Resolver
```javascript
// app/parsers/utils/external-ref-resolver.js
class ExternalRefResolver {
  /**
   * Resolve external $ref with caching and retry logic
   * @param {string} refUri - URI to resolve (http://, file://, etc.)
   * @param {Object} options - Resolution options
   * @returns {Promise<ResolvedRef>}
   */
  async resolveExternal(refUri, options = {}) {}

  /**
   * Batch resolve multiple refs in parallel
   * @param {string[]} refUris - Array of URIs to resolve
   * @returns {Promise<Map<string, ResolvedRef>>}
   */
  async resolveBatch(refUris) {}

  /**
   * Clear resolution cache
   */
  clearCache() {}
}
```

#### 2. Circular Reference Detector
```javascript
// app/parsers/utils/circular-ref-detector.js
class CircularRefDetector {
  /**
   * Detect circular references using graph traversal
   * @param {Object} spec - Parsed OpenAPI spec
   * @returns {CircularRefResult}
   */
  detectCircular(spec) {}

  /**
   * Get dependency graph for visualization
   * @returns {DependencyGraph}
   */
  getDependencyGraph() {}
}
```

#### 3. Structured Error Model
```javascript
// app/parsers/utils/error-model.js
class ParserError extends Error {
  constructor(code, message, context = {}) {
    super(message);
    this.code = code;
    this.severity = context.severity || 'ERROR';
    this.path = context.path || null;
    this.location = context.location || null;
    this.recoverable = context.recoverable || false;
    this.timestamp = new Date().toISOString();
  }
}

// Error codes registry
const ERROR_CODES = {
  // Spec validation errors (100-199)
  'OPENAPI_001': 'Invalid OpenAPI version',
  'OPENAPI_002': 'Missing required field',
  'OPENAPI_003': 'Invalid spec structure',

  // Reference errors (200-299)
  'REF_001': 'External reference resolution failed',
  'REF_002': 'Circular reference detected',
  'REF_003': 'Invalid reference URI',
  'REF_004': 'Reference not found',

  // Schema errors (300-399)
  'SCHEMA_001': 'Invalid schema definition',
  'SCHEMA_002': 'Unsupported schema feature',

  // Network errors (400-499)
  'NET_001': 'Network timeout',
  'NET_002': 'Connection refused',
  'NET_003': 'TLS/SSL error',

  // Parse errors (500-599)
  'PARSE_001': 'JSON/YAML syntax error',
  'PARSE_002': 'Encoding error',
  'PARSE_003': 'File not found'
};
```

#### 4. Progress Tracker
```javascript
// app/parsers/utils/progress-tracker.js
class ProgressTracker extends EventEmitter {
  /**
   * Track parsing progress with events
   * @param {Object} options - Tracking options
   */
  constructor(options = {}) {
    this.totalSteps = options.totalSteps || 6;
    this.currentStep = 0;
    this.metadata = {};
  }

  /**
   * Update progress and emit event
   * @param {string} stage - Current stage name
   * @param {number} progress - Progress percentage (0-100)
   */
  update(stage, progress) {}

  /**
   * Mark stage as complete
   */
  completeStage(stage, metadata = {}) {}
}

// Event structure:
// {
//   stage: 'extracting_endpoints',
//   progress: 45,
//   message: 'Extracted 23 of 51 endpoints',
//   timestamp: '2025-10-06T...'
// }
```

### Enhanced Core Parser
```javascript
// Updates to app/parsers/openapi-parser.js
class OpenAPIParser {
  constructor(options = {}) {
    this.options = {
      ...options,
      resolveRefs: 'all',           // 'local' | 'all' | 'none'
      detectCircular: true,         // Enable circular ref detection
      allowCircular: false,         // Fail or warn on circular refs
      maxRefDepth: 10,              // Prevent infinite resolution
      refCache: true,               // Cache external refs
      progressTracking: true,       // Emit progress events
      errorMode: 'collect',         // 'throw' | 'collect' | 'ignore'
      retryOptions: {
        maxRetries: 3,
        backoff: 'exponential'
      }
    };

    // New components
    this.externalRefResolver = new ExternalRefResolver(this.options);
    this.circularDetector = new CircularRefDetector();
    this.progressTracker = new ProgressTracker();
    this.errors = [];
    this.warnings = [];
  }

  /**
   * Parse with enhanced error collection
   */
  async parse(source) {
    this.progressTracker.update('initializing', 0);

    try {
      // Existing logic + new error handling
      // Emit progress at each stage
      // Collect errors instead of throwing (if errorMode='collect')
    } catch (error) {
      this._handleError(error);
    }

    return {
      ...this.parsedSpec,
      errors: this.errors,
      warnings: this.warnings,
      hasErrors: this.errors.length > 0,
      hasWarnings: this.warnings.length > 0
    };
  }
}
```

### Out of Scope (Future Missions)
- OAS 2.0 backward compatibility â†’ Future
- GraphQL schema parsing â†’ Future
- AsyncAPI integration â†’ Future (Week 8+)
- Custom validation rules DSL â†’ Future

---

## Implementation Plan

### Phase 1: External $ref Resolution (Day 3, Part 1)
- [ ] Create ExternalRefResolver with HTTP/HTTPS support
- [ ] Implement file:// protocol support for local refs
- [ ] Add LRU cache for resolved refs
- [ ] Implement retry logic with exponential backoff
- [ ] Add timeout handling (configurable, default 5s)

**Files to Create/Modify:**
- `app/parsers/utils/external-ref-resolver.js` (new)
- `app/parsers/utils/ref-resolver.js` (extend existing)
- `app/parsers/openapi-parser.js` (integrate)

### Phase 2: Circular Reference Detection (Day 3, Part 2)
- [ ] Implement graph-based circular detection
- [ ] Reuse Tarjan's algorithm from existing codebase
- [ ] Create dependency graph visualization output
- [ ] Add configurable handling (fail/warn/allow)
- [ ] Generate helpful error messages with path traces

**Files to Create/Modify:**
- `app/parsers/utils/circular-ref-detector.js` (new)
- Integration with existing `app/core/graph/tarjan.js`

### Phase 3: Structured Error Model (Day 3, Part 3)
- [ ] Define comprehensive error code taxonomy
- [ ] Create ParserError class hierarchy
- [ ] Implement error collection vs. throw modes
- [ ] Add severity levels (ERROR, WARN, INFO)
- [ ] Create error context with location info
- [ ] Add recovery suggestions where applicable

**Files to Create:**
- `app/parsers/utils/error-model.js`
- `app/parsers/utils/error-codes.js`

### Phase 4: Progress Tracking (Day 4, Part 1)
- [ ] Implement ProgressTracker with EventEmitter
- [ ] Define progress stages and events
- [ ] Integrate with parser stages
- [ ] Add optional progress callback support
- [ ] Create CLI progress bar integration

**Files to Create:**
- `app/parsers/utils/progress-tracker.js`
- `app/cli/utils/progress-bar.js` (enhance existing)

### Phase 5: Parser Integration (Day 4, Part 2)
- [ ] Integrate all components into main parser
- [ ] Update parse() method with error collection
- [ ] Add configuration validation
- [ ] Implement batch parsing with progress
- [ ] Update CLI commands to use new features

**Files to Modify:**
- `app/parsers/openapi-parser.js`
- `app/cli/commands/discover.js`

### Phase 6: Testing & Documentation (Day 4, Part 3)
- [ ] Unit tests for each new component
- [ ] Integration tests with complex specs
- [ ] Error handling test coverage
- [ ] Performance regression tests
- [ ] Update README and API docs

**Files to Create:**
- `app/tests/parsers/external-ref-resolver.test.js`
- `app/tests/parsers/circular-ref-detector.test.js`
- `app/tests/parsers/error-model.test.js`
- `app/tests/parsers/progress-tracker.test.js`
- `app/tests/parsers/integration-advanced.test.js`

### Phase 7: Fixtures & Examples (Day 4, Part 4)
- [ ] Create test fixtures with external refs
- [ ] Add circular reference examples
- [ ] Document error code catalog
- [ ] Create usage examples

**Files to Create:**
- `app/fixtures/openapi/with-external-refs.json`
- `app/fixtures/openapi/with-circular-refs.json`
- `app/fixtures/openapi/external-schemas/*.json`
- `docs/ERROR_CODES.md`
- `docs/PARSER_GUIDE.md`

---

## Success Criteria

### Functional Requirements
- [ ] Resolve external $refs via HTTP/HTTPS and file://
- [ ] Detect circular references with 100% accuracy
- [ ] Collect and categorize errors by severity
- [ ] Emit progress events for all parsing stages
- [ ] Handle network failures gracefully with retries
- [ ] Generate dependency graphs for complex specs

### Performance Requirements
- [ ] External ref resolution <500ms per ref (cached: <10ms)
- [ ] Circular detection adds <50ms overhead
- [ ] Error model overhead <10ms
- [ ] Progress events <1ms each
- [ ] Memory efficient for large specs (<100MB for 50k lines)

### Test Coverage
- [ ] 90%+ code coverage for new components
- [ ] All error codes have test cases
- [ ] Network failure scenarios covered
- [ ] Circular reference edge cases tested
- [ ] Performance benchmarks passing

### Error Handling
- [ ] All error codes documented
- [ ] Helpful error messages with context
- [ ] Recoverable vs. fatal errors distinguished
- [ ] Error paths include location information
- [ ] Suggestions provided where applicable

---

## Files to Create/Modify

```
app/parsers/
â”œâ”€â”€ openapi-parser.js                      # Enhanced with new features
â””â”€â”€ utils/
    â”œâ”€â”€ external-ref-resolver.js           # NEW: External ref resolution
    â”œâ”€â”€ circular-ref-detector.js           # NEW: Circular detection
    â”œâ”€â”€ error-model.js                     # NEW: Structured errors
    â”œâ”€â”€ error-codes.js                     # NEW: Error code registry
    â”œâ”€â”€ progress-tracker.js                # NEW: Progress events
    â””â”€â”€ ref-resolver.js                    # MODIFY: Extend for external

app/tests/parsers/
â”œâ”€â”€ external-ref-resolver.test.js          # NEW
â”œâ”€â”€ circular-ref-detector.test.js          # NEW
â”œâ”€â”€ error-model.test.js                    # NEW
â”œâ”€â”€ progress-tracker.test.js               # NEW
â””â”€â”€ integration-advanced.test.js           # NEW

app/fixtures/openapi/
â”œâ”€â”€ with-external-refs.json                # NEW
â”œâ”€â”€ with-circular-refs.json                # NEW
â””â”€â”€ external-schemas/
    â”œâ”€â”€ user-schema.json                   # NEW
    â””â”€â”€ product-schema.json                # NEW

app/cli/
â”œâ”€â”€ commands/discover.js                   # MODIFY: Use enhanced parser
â””â”€â”€ utils/progress-bar.js                  # MODIFY: Wire progress events

docs/
â”œâ”€â”€ ERROR_CODES.md                         # NEW: Error catalog
â””â”€â”€ PARSER_GUIDE.md                        # NEW: Usage guide
```

---

## Integration Points

### With Week 7 Missions
- **B7.2.0** (State Machine): Uses error model for transition failures
- **B7.2.1** (Registry): Requires external ref resolution for distributed catalogs
- **B7.3.0** (Workflows): Leverages progress events for orchestration

### With Existing Codebase
- **Tarjan's Algorithm** (`app/core/graph/tarjan.js`): Reuse for circular detection
- **Progress Utilities** (`app/cli/utils/progress.js`): Extend for parser progress
- **Security Redaction** (B5.2): Apply to error messages containing sensitive data
- **Catalog Index** (B5.1): Store resolved external refs

---

## Context for AI Assistant

### What Already Exists
- âœ… Core OpenAPI parser (B7.1.0) with streaming and local $refs
- âœ… Tarjan's algorithm for SCC detection (`app/core/graph/tarjan.js`)
- âœ… Progress utilities in CLI (`app/cli/utils/progress.js`)
- âœ… Security redaction (B5.2) for sensitive data
- âœ… Test infrastructure and fixtures

### Key Patterns to Reuse
- Graph algorithms from `app/core/graph/` for circular detection
- Error handling patterns from existing importers
- Progress tracking from CLI utilities
- Caching patterns from protocol-graph cache
- Retry logic patterns from network operations

### Dependencies to Add
```json
{
  "node-fetch": "^3.3.0",
  "lru-cache": "^10.0.1",
  "p-retry": "^5.1.0",
  "eventemitter3": "^5.0.0"
}
```

### Error Code Design Principles
1. **Hierarchical**: Group by domain (OPENAPI_*, REF_*, SCHEMA_*, etc.)
2. **Actionable**: Each error includes recovery suggestions
3. **Contextual**: Include file path, line number, field name where applicable
4. **Severity-aware**: ERROR (blocks), WARN (fixable), INFO (advisory)
5. **Machine-readable**: Structured for programmatic handling

---

## Handoff Context for Next Mission

Upon completion, provide:

```json
{
  "completed": [
    "External $ref resolution (HTTP/HTTPS/file://)",
    "Circular reference detection with dependency graphs",
    "Structured error model with 30+ error codes",
    "Progress tracking with event emission",
    "Enhanced parser with error collection mode",
    "Comprehensive test coverage (90%+)"
  ],
  "interfaces": [
    "ExternalRefResolver.resolveExternal(uri)",
    "CircularRefDetector.detectCircular(spec)",
    "ParserError with code/severity/context",
    "ProgressTracker extends EventEmitter",
    "OpenAPIParser with errors[] and warnings[]"
  ],
  "assumptions": [
    "External refs assume network availability",
    "Circular refs use existing Tarjan implementation",
    "Error collection mode returns partial results",
    "Progress events are optional (can be disabled)",
    "Caching uses LRU with configurable size"
  ],
  "performance_achieved": {
    "external_ref_ms": "actual avg resolution time",
    "circular_detection_ms": "actual overhead",
    "error_overhead_ms": "actual processing cost",
    "memory_usage_mb": "peak for 50k line spec"
  },
  "next_mission": "B7.2.0 - Agent Registration State Machine",
  "blockers": []
}
```

---

## Notes

### Important Decisions Made
1. **Error collection mode**: Return partial results with errors[] instead of throwing
2. **LRU caching**: Cache external refs to prevent redundant network calls
3. **Tarjan reuse**: Leverage existing SCC algorithm for circular detection
4. **EventEmitter pattern**: Use Node.js native events for progress tracking
5. **Severity levels**: ERROR/WARN/INFO for triaging parse issues
6. **Exponential backoff**: Handle transient network failures gracefully

### Watch Out For
- External refs may point to non-existent resources (404s)
- Circular refs can be intentional (e.g., recursive schemas)
- Network timeouts need reasonable defaults (5s)
- Error messages must not leak sensitive data (apply B5.2 redaction)
- Progress events can add overhead if emitted too frequently
- Cache invalidation for external refs needs TTL strategy

### Testing Strategy
- **Unit**: Each component in isolation with mocks
- **Integration**: Real OpenAPI specs with external refs
- **Performance**: Benchmark against 10k/50k line specs
- **Error paths**: Force failures for all error codes
- **Network**: Mock HTTP responses for reliability

---

## Week 7 Context

**Week 7 Theme**: Protocol Suite Enhancement

**Mission Order**:
1. **B7.1.0** (Complete): OpenAPI Parser Core âœ…
2. **B7.1.1** (ACTIVE): Parser Extensions & Error Model ðŸš€
3. **B7.2.0**: Agent Registration State Machine
4. **B7.2.1**: Registry & Graph Integration
5. **B7.3.0**: Workflow Definition Library
6. **B7.4.0**: Structured Feedback System
7. **B7.5.0**: Protocol Scaffolding Tool
8. **B7.6.0**: Test Infrastructure & CI

**Week 7 Success**: Complete protocol enhancement suite with parsing, registration, workflows, and testing infrastructure

---

*Mission B7.1.1 Active ðŸš€*
*Previous: B7.1.0 - OpenAPI Parser Core (Complete)*
*Next: B7.2.0 - Agent Registration State Machine*
*Updated: October 6, 2025*

---

## Mission Completion Requirements

When this mission is complete, you MUST update the following project documentation:

### ðŸ“‹ DOCUMENTATION CHECKLIST
- [ ] All code files created and tested
- [ ] PROJECT_CONTEXT.json updated
- [ ] AI_HANDOFF.md updated
- [ ] Session logged in SESSIONS.jsonl
- [ ] missions/current.md updated to next mission (B7.2.0)
- [ ] All files committed if using git

**IMPORTANT**: Mission is not complete until ALL documentation is updated!
