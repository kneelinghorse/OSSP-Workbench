#!/usr/bin/env node

import fs from 'fs/promises';
import path from 'path';
import { fileURLToPath } from 'url';
import { importAsyncAPI } from '../../packages/runtime/importers/asyncapi/importer.js';
import { generateEventConsumer } from '../../packages/runtime/generators/consumers/index.js';
import {
  GOLDEN_CONSUMER_SCENARIOS,
  findScenarioManifest
} from './golden-consumer-scenarios.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const PROJECT_ROOT = path.resolve(__dirname, '..', '..');
const GOLDEN_ROOT = path.join(PROJECT_ROOT, 'tests', 'fixtures', 'golden', 'consumers');

async function writeText(filePath, value) {
  await fs.mkdir(path.dirname(filePath), { recursive: true });
  await fs.writeFile(filePath, `${String(value).trimEnd()}\n`, 'utf8');
}

async function writeScenarioReadme(scenario, outputDir) {
  const lines = [
    '# Golden Consumer Scenario',
    '',
    `- Scenario: ${scenario.id}`,
    `- Description: ${scenario.description}`,
    `- Spec: ${scenario.specPath}`,
    `- Transport: ${scenario.transport}`,
    `- Event: ${scenario.eventName}`,
    '',
    'These files are generated by `npm run test:golden:update`.',
    'Compatibility tests assert exact output matches to detect generator drift.'
  ];
  await writeText(path.join(outputDir, 'README.md'), lines.join('\n'));
}

async function updateGoldenOutputs() {
  for (const scenario of GOLDEN_CONSUMER_SCENARIOS) {
    const specPath = path.resolve(PROJECT_ROOT, scenario.specPath);
    const imported = await importAsyncAPI(specPath, { timeout: 60000 });
    const manifest = findScenarioManifest(imported, scenario);

    if (!manifest) {
      throw new Error(
        `Unable to locate manifest for scenario ${scenario.id} (${scenario.transport}/${scenario.eventName})`
      );
    }

    const generated = generateEventConsumer(manifest, {
      typescript: false,
      includeTests: true,
      includePIIUtil: true
    });

    const outputDir = path.join(GOLDEN_ROOT, scenario.id);
    await fs.mkdir(outputDir, { recursive: true });

    await writeText(path.join(outputDir, 'consumer.js'), generated.consumer);
    await writeText(path.join(outputDir, 'consumer.test.js'), generated.test || '');
    await writeText(path.join(outputDir, 'pii-masking.js'), generated.piiUtil || '');
    await writeScenarioReadme(scenario, outputDir);
  }
}

async function main() {
  await updateGoldenOutputs();
  console.log(`Updated golden outputs: ${path.relative(PROJECT_ROOT, GOLDEN_ROOT)}`);
}

main().catch((error) => {
  console.error(`Failed to update golden outputs: ${error.message}`);
  process.exit(1);
});
